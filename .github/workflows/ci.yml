name: C++ Inference CI/CD

# 触发条件：推送到 main 分支，或者发起 Pull Request 时
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-24.04  # 使用 GitHub 最新的 Ubuntu 环境

    steps:
    # 1. 拉取代码
    - name: Checkout code
      uses: actions/checkout@v4

    # 设置 Python 环境
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    # 安装 DVC和OSS插件 
    - name: Install DVC
      run: |
        pip install dvc[oss]

    # 从阿里云拉取模型
    - name: Pull models from DVC
      env:
        # 这里使用环境变量注入密钥，防止密钥泄露
        GTO_AccessKeyId: ${{ secrets.OSS_ACCESS_KEY_ID }}
        GTO_AccessKeySecret: ${{ secrets.OSS_ACCESS_KEY_SECRET }}
      run: |
        # 临时配置认证信息 (不带 --local，因为 CI 环境是临时的)
        dvc remote modify origin oss_key_id ${{ secrets.OSS_ACCESS_KEY_ID }}
        dvc remote modify origin oss_key_secret ${{ secrets.OSS_ACCESS_KEY_SECRET }}
        # 拉取数据
        dvc pull
    
    # 2. 设置 Docker 环境
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # 3. 构建 Docker 镜像
    - name: Build Docker Image
      run: |
        docker build --network=host -t playground-detector:latest .

    # 运行测试 (全新重写！)
    - name: Test Service
      run: |
        # 1. 后台启动容器 (-d), 使用 host 网络模式以便直接访问端口
        # --name detector: 给容器起个名方便后面杀掉
        docker run -d --network=host --name detector \
          -v ${{ github.workspace }}/data:/app/data \
          playground-service:latest

        # 2. 等待服务启动 (C++ 很快，5秒足够了)
        echo "Waiting for server to start..."
        sleep 5

        # 3. 查看一下容器日志 (方便调试)
        docker logs detector

        # 4. 发送测试请求
        # 我们把结果存到一个变量里
        RESPONSE=$(curl -s -X POST -H "Content-Type: application/json" \
          -d '{"image_path": "/app/data/test_images/playground_209.jpg"}' \
          http://localhost:8080/predict)

        echo "Server Response: $RESPONSE"

        # 5. 验证结果
        # 检查返回的 JSON 字符串里是否包含 "success"
        if [[ "$RESPONSE" == *"success"* ]]; then
          echo "✅ Test Passed: Service responded with success!"
        else
          echo "❌ Test Failed: Invalid response!"
          exit 1
        fi

        # 6. 清理容器
        docker stop detector